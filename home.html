<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JLMSï½œSentence Practice</title>
  <link rel="stylesheet" href="style/main.css" />
</head>
<body>
  <div class="main-container">
    <h1>
      <img src="https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f4d8.svg" alt="book">
      RÃ©pÃ©tition des phrasesÂ â€“Â Chinois de la vie quotidienne
    </h1>

    <!-- â”€â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="toolbar">
      <label>Bookï¼š
        <select id="bookSelect"></select>
      </label>

      <label>Lessonï¼š
        <select id="lessonSelect"></select>
      </label>

      <label>
        <input type="checkbox" id="togglePinyin" checked>
        ShowÂ pinyin
      </label>

      <label>Speedï¼š
        <input type="range"
               id="rateSlider"
               min="0.3" max="1.4" step="0.1" value="0.6">
        <span id="rateValue">0.6</span>
      </label>
    </div>

    <div id="sentenceList"></div>
  </div>

<!-- â”€â”€â”€ Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
  const bookSelect   = document.getElementById("bookSelect");
  const lessonSelect = document.getElementById("lessonSelect");
  const sentenceList = document.getElementById("sentenceList");
  const togglePinyin = document.getElementById("togglePinyin");
  const rateSlider   = document.getElementById("rateSlider");
  const rateValue    = document.getElementById("rateValue");

  /* æŠŠ Book 1â€“4 å¡é€²ä¸‹æ‹‰é¸å–® */
  for (let i = 1; i <= 4; i++) {
    bookSelect.insertAdjacentHTML("beforeend",
      `<option value="${i}">Book ${i}</option>`);
  }

  /* Book â†’ lesson ç¯„åœ */
  const lessonMap = { 1:[1,5], 2:[6,10], 3:[11,15], 4:[16,20] };

  /* Init ç›£è½ */
  bookSelect .addEventListener("change", updateLessonOptions);
  lessonSelect.addEventListener("change", loadLesson);
  togglePinyin.addEventListener("change", loadLesson);
  rateSlider .addEventListener("input", () => rateValue.textContent = rateSlider.value);
  updateLessonOptions();        // é€²é é¢å…ˆè·‘ä¸€æ¬¡

  /* ä¾æ›¸å†Šæ›´æ–°èª²æ¬¡é¸å–® */
  function updateLessonOptions () {
    const [start,end] = lessonMap[bookSelect.value];
    lessonSelect.innerHTML = "";
    for(let i=start; i<=end; i++){
      lessonSelect.insertAdjacentHTML("beforeend",
        `<option value="L${i}">L.${i}</option>`);
    }
    loadLesson();
  }

  /* æŠ“è©²èª² JSON */
  async function loadLesson () {
    const lesson = lessonSelect.value;
    sentenceList.innerHTML = "<p>Loadingâ€¦</p>";
    try{
      const res  = await fetch(`data/${lesson}.json`);
      const data = await res.json();
      renderSentences(data);
    }catch{
      sentenceList.innerHTML = "<p>âŒ Data for this lesson not found.</p>";
    }
  }

  /* ç”¢ç”Ÿå¥å­å¡ */
  function renderSentences (sentences){
    sentenceList.innerHTML = "";
    const showPinyin = togglePinyin.checked;

    sentences.forEach(item=>{
      // å¤–æ¡†
      const card = document.createElement("div");
      card.className = "sentence-card";

      // æ¼¢å­—
      const hanzi = document.createElement("div");
      hanzi.className = "sentence-text";
      hanzi.textContent = item.hanzi;
      hanzi.onclick = ()=> playBrowserVoice(hanzi);

      // æ‹¼éŸ³
      const pinyin = document.createElement("div");
      pinyin.className = "pinyin-text";
      pinyin.textContent = item.pinyin;
      pinyin.style.display = showPinyin ? "block" : "none";

      // OpenAI TTS æŒ‰éˆ•
      const btn = document.createElement("button");
      btn.className = "audio-button";
      btn.textContent = "ğŸ™Â NaturalÂ TTS";
      btn.onclick = () => playOpenAITTS(item.hanzi);

      card.append(hanzi,pinyin,btn);
      sentenceList.appendChild(card);
    });
  }

  /* â€”â€” ç€è¦½å™¨å…§å»ºèªéŸ³ï¼ˆé»æ¼¢å­—ï¼‰ â€”â€” */
  function playBrowserVoice(el){
    const msg  = new SpeechSynthesisUtterance(el.textContent);
    msg.lang   = "zh-TW";
    msg.rate   = parseFloat(rateSlider.value);
    document.querySelectorAll(".sentence-text")
            .forEach(e=>e.classList.remove("playing"));
    el.classList.add("playing");
    speechSynthesis.speak(msg);
  }

  /* â€”â€” OpenAI TTS ï¼ˆé» Natural TTSï¼‰ â€”â€” */
  async function playOpenAITTS(text){
    try{
      const res = await fetch("/api/speak",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          text,
          voice:"shimmer",                 // ä½ å¯ä»¥æ”¹ maleâ€‘voice ä¹‹é¡
          speed:parseFloat(rateSlider.value)
        })
      });

      if(!res.ok){
        const err = await res.json();
        alert("TTS error: "+JSON.stringify(err));
        return;
      }
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      new Audio(url).play();
    }catch(e){
      alert("Network / CORS error ğŸ˜¥");
    }
  }
</script>
</body>
</html>
