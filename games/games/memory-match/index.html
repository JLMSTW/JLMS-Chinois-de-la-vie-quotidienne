<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Mandarin Memory Match</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --glass: rgba(255,255,255,.2);
      --glass-bd: rgba(255,255,255,.35);
      --shadow: 0 8px 24px rgba(0,0,0,.15);
      --radius: 18px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #8aa6ff 0%, #7b89ff 20%, #6d6fd6 35%, #5e5fb6 55%, #4f4f96 75%, #3e3e6e 100%);
      min-height:100vh;
      color:#fff;
      padding:22px;
    }
    .container{max-width:1200px;margin:0 auto}

    /* Header */
    .header{ text-align:center; margin:8px 0 10px }
    .title{
      font-size:2.3rem; font-weight:800; letter-spacing:.2px;
      text-shadow: 2px 2px 6px rgba(0,0,0,.35);
    }
    .subtitle{ opacity:.92; margin-top:6px }

    /* Toolbar */
    .toolbar{
      display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap;
      margin:18px 0 8px;
    }
    .chip-label{font-weight:700; opacity:.9}
    .select, .btn{
      appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer;
    }
    .select{ background:#fff; color:#2c3e50 }
    .btn{
      background:linear-gradient(135deg,#ff9a9e,#fecfef); color:#2c3e50; box-shadow:0 4px 12px rgba(0,0,0,.18);
      transition:transform .2s, box-shadow .2s;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.24) }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:6px;
    }

    /* Stats */
    .stats{
      display:flex; justify-content:center; gap:22px; flex-wrap:wrap; margin:12px 0 20px;
    }
    .stat{
      background:var(--glass); padding:12px 18px; border-radius:14px; text-align:center;
      backdrop-filter: blur(10px); border:1px solid var(--glass-bd);
    }
    .stat .num{ font-size:1.4rem; font-weight:800; display:block }
    .stat .lbl{ font-size:.85rem; opacity:.85 }

    /* Board */
    .board{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:18px; margin: 8px 0 28px;
    }
    .card{ aspect-ratio:3/4; perspective:1000px; cursor:pointer }
    .card.disabled{ pointer-events:none }
    .card-inner{
      position:relative; width:100%; height:100%; text-align:center;
      transition: transform .6s; transform-style:preserve-3d;
    }
    .card.flipped .card-inner{ transform:rotateY(180deg) }

    .face{
      position:absolute; inset:0; backface-visibility:hidden; border-radius:var(--radius);
      display:flex; flex-direction:column; justify-content:center; align-items:center; padding:18px;
      box-shadow: var(--shadow); border:3px solid var(--glass-bd);
    }
    .front{ background: linear-gradient(135deg,#ff6b6b,#ee5a24) }
    .back{  background: linear-gradient(135deg,#4ecdc4,#44a08d); transform: rotateY(180deg) }
    .back.french{ background: linear-gradient(135deg,#a8edea,#fed6e3); color:#2c3e50 }

    .hanzi{ font-family:'Noto Sans SC', sans-serif; font-size:2.2rem; font-weight:800; margin-bottom:8px; text-shadow: 2px 2px 4px rgba(0,0,0,.3) }
    .pinyin{ font-size:1.08rem; font-weight:600; opacity:.95; font-style:italic }
    .meaning{ font-size:1.12rem; font-weight:800; text-align:center; line-height:1.33 }

    .card.matched{ opacity:.7; transform: scale(.98) }
    .card.matched .card-inner{ transform: rotateY(180deg) }

    /* Victory */
    .victory{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35);
      z-index:1000;
    }
    .victory .panel{
      background:linear-gradient(135deg,#667eea,#764ba2); padding:30px 34px; border-radius:18px;
      text-align:center; box-shadow: 0 20px 40px rgba(0,0,0,.3);
      min-width: 280px;
    }
    .victory h2{ font-size:1.7rem; margin-bottom:8px }
    .victory p{ margin-bottom:14px }

    .note{ text-align:center; opacity:.9; margin-top:6px }

    @media (max-width:768px){
      .board{ grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:14px }
      .hanzi{ font-size:1.9rem }
      .meaning{ font-size:1rem }
      .title{ font-size:1.9rem }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">ðŸ§  Mandarin Memory Match</h1>
      <p class="subtitle">Match Chinese characters with their French meanings!</p>
    </header>

    <!-- Top controls -->
    <div class="toolbar">
      <span class="chip-label">Difficulty</span>
      <select id="difficulty" class="select" title="Difficulty">
        <option value="easy" selected>Easyï¼ˆ6 å­—ï¼‰</option>
        <option value="advanced">Advancedï¼ˆ11 å­—ï¼‰</option>
      </select>

      <button id="newGameBtn" class="btn">ðŸ”„ New Game</button>
    </div>

    <!-- Filters -->
    <div class="filters">
      <select id="filterBook" class="select" title="Book"></select>
      <select id="filterLesson" class="select" title="Lesson"></select>
      <select id="filterLevel" class="select" title="TOCFL Level"></select>
      <select id="filterPos" class="select" title="POS"></select>
    </div>

    <!-- Stats -->
    <section class="stats">
      <div class="stat"><span id="moves" class="num">0</span><span class="lbl">Moves</span></div>
      <div class="stat"><span id="matches" class="num">0</span><span class="lbl">Matches</span></div>
      <div class="stat"><span id="timer" class="num">00:00</span><span class="lbl">Time</span></div>
      <div class="stat"><span id="levelTag" class="num">â€”</span><span class="lbl">Level</span></div>
    </section>

    <p id="loading" class="note">Loadingâ€¦</p>

    <!-- Game board -->
    <main id="board" class="board" aria-live="polite"></main>
  </div>

  <!-- Victory -->
  <section id="victory" class="victory" role="dialog" aria-modal="true" aria-labelledby="vTitle">
    <div class="panel">
      <h2 id="vTitle">ðŸŽ‰ FÃ©licitations!</h2>
      <p>You've matched all the vocabulary pairs!</p>
      <button id="playAgainBtn" class="btn">Play Again</button>
    </div>
  </section>

  <!-- ===== GAME SCRIPT ===== -->
  <script type="module">
    import { GAS_ENDPOINT, SHEETS, PREF } from "/js/config.js";

    // ---- constants / state ----
    const FLIP_BACK_DELAY = 2000; // æ”¾æ…¢ç‚º 2.0s
    const boardEl   = document.getElementById("board");
    const loadingEl = document.getElementById("loading");
    const movesEl   = document.getElementById("moves");
    const matchesEl = document.getElementById("matches");
    const timerEl   = document.getElementById("timer");
    const levelTag  = document.getElementById("levelTag");
    const victoryEl = document.getElementById("victory");

    const selDifficulty = document.getElementById("difficulty");
    const selBook   = document.getElementById("filterBook");
    const selLesson = document.getElementById("filterLesson");
    const selLevel  = document.getElementById("filterLevel");
    const selPos    = document.getElementById("filterPos");

    const params = new URLSearchParams(location.search);
    const SET_FROM_URL = params.get("set") || ""; // e.g. B4_L16

    let rawItems = [];   // ä¾†è‡ª GAS çš„åŽŸå§‹è³‡æ–™
    let pool     = [];   // ä¾ç¯©é¸å¾Œå¯ç”¨çš„è³‡æ–™
    let deck     = [];   // ç‰Œåº«ï¼ˆå…©å€ï¼‰
    let game     = {};   // éŠæˆ²ç‹€æ…‹
    let timerId  = null;

    // ---- helpers ----
    const by = (k) => (a,b)=> (a[k]||"").localeCompare(b[k]||"");
    const uniq = (arr)=> Array.from(new Set(arr.filter(Boolean)));
    const fmtTime = (s)=> {
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    };
    const setLoading = (on)=> loadingEl.textContent = on ? "Loadingâ€¦" : "";

    const updateURL = ()=>{
      const u = new URL(location.href);
      u.searchParams.set("mode", selDifficulty.value);
      u.searchParams.set("book", selBook.value);
      u.searchParams.set("lesson", selLesson.value);
      u.searchParams.set("level", selLevel.value);
      u.searchParams.set("pos", selPos.value);
      if (SET_FROM_URL) u.searchParams.set("set", SET_FROM_URL);
      history.replaceState(null, "", u);
    };

    // ---- fetch from GAS ----
    async function fetchItems(){
      setLoading(true);
      const url = new URL(GAS_ENDPOINT);
      url.searchParams.set("sheet", SHEETS.memory);
      url.searchParams.set("active", "true");
      if (SET_FROM_URL) url.searchParams.set("set", SET_FROM_URL);

      const res = await fetch(url.toString(), { credentials: "omit" });
      if(!res.ok) throw new Error(`Fetch failed ${res.status}`);
      const data = await res.json();

      // æ­£è¦åŒ– keyï¼ˆä¿å®ˆè™•ç†å¤§å°å¯«/åº•ç·šï¼‰
      rawItems = (data.items || []).map(x => ({
        set_id:       x.set_id ?? x.setId ?? "",
        book:         x.book ?? x.Book ?? "",
        lesson:       x.lesson ?? x.Lesson ?? "",
        chinese_tr:   x.chinese_tr ?? x.chineseTR ?? x.chinesetr ?? x[PREF?.hanzi] ?? "",
        pinyin_tw:    x.pinyin_tw ?? x.pinyintw ?? x[PREF?.pinyin] ?? "",
        meaning_fr:   x.meaning_fr ?? x.meaningFR ?? "",
        meaning_en:   x.meaning_en ?? x.meaningEN ?? "",
        tocfl_level:  x.tocfl_level ?? x.TOCFL_Level ?? x.tocfl ?? "",
        pos:          x.pos ?? x.part_of_speech ?? "",
        active:       String(x.active ?? x.Active ?? "").toUpperCase() === "TRUE",
      }));

      setLoading(false);
    }

    // ---- build filters ----
    function buildFilters(){
      const opt = (val, text)=> `<option value="${val}">${text}</option>`;
      const books   = uniq(rawItems.map(i=>i.book)).sort();
      const lessons = uniq(rawItems.map(i=>i.lesson)).sort(by(undefined));
      const lvls    = uniq(rawItems.map(i=>i.tocfl_level)).sort();
      const poses   = uniq(rawItems.map(i=>i.pos)).sort();

      selBook.innerHTML   = opt("", "Book: All")   + books.map(b=>opt(b, b||"â€”")).join("");
      selLesson.innerHTML = opt("", "Lesson: All") + lessons.map(l=>opt(l, l||"â€”")).join("");
      selLevel.innerHTML  = opt("", "TOCFL: All")  + lvls.map(l=>opt(l, l||"â€”")).join("");
      selPos.innerHTML    = opt("", "POS: All")    + poses.map(p=>opt(p, p||"â€”")).join("");

      // å¾ž URL é‚„åŽŸ
      selBook.value   = params.get("book")   ?? "";
      selLesson.value = params.get("lesson") ?? "";
      selLevel.value  = params.get("level")  ?? "";
      selPos.value    = params.get("pos")    ?? "";
    }

    // ---- apply filters ----
    function filterPool(){
      pool = rawItems.filter(i => i.active
        && i.chinese_tr
        && (i.meaning_fr || i.meaning_en)
      );

      if (selBook.value)   pool = pool.filter(i => i.book === selBook.value);
      if (selLesson.value) pool = pool.filter(i => i.lesson === selLesson.value);
      if (selLevel.value)  pool = pool.filter(i => (i.tocfl_level||"").toUpperCase() === selLevel.value.toUpperCase());
      if (selPos.value)    pool = pool.filter(i => (i.pos||"").toLowerCase() === selPos.value.toLowerCase());

      // è‹¥ URL æœ‰ setï¼Œåšé›™ä¿éšªï¼ˆset_id = Book_Lessonï¼‰
      if (SET_FROM_URL){
        pool = pool.filter(i => (i.set_id||"").toLowerCase() === SET_FROM_URL.toLowerCase());
      }
    }

    // ---- build deck ----
    function pickN(arr, n){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a.slice(0, n);
    }

    function buildDeck(){
      const pairs = selDifficulty.value === "advanced" ? 11 : 6;
      const candidates = pool.length >= pairs ? pool : pool; // ä¸è¶³æ™‚å°±å…¨å–

      const chosen = pickN(candidates, Math.min(pairs, candidates.length));
      const toMeaning = (i)=> i.meaning_fr || i.meaning_en || "";

      const temp = [];
      chosen.forEach((item, idx)=>{
        const hanzi  = item.chinese_tr;
        const pinyin = item.pinyin_tw || "";
        const meaning = toMeaning(item);
        if(!hanzi || !meaning) return;

        temp.push({
          type: "hanzi", pair: idx,
          hanzi, pinyin
        });
        temp.push({
          type: "meaning", pair: idx,
          meaning
        });
      });

      deck = pickN(temp, temp.length); // æ‰“æ•£
    }

    // ---- rendering ----
    function cardEl(card){
      const el = document.createElement("div");
      el.className = "card";
      el.dataset.pair = card.pair;

      const inner = document.createElement("div");
      inner.className = "card-inner";

      const front = document.createElement("div");
      front.className = "face front";
      front.innerHTML = `<div style="font-size:2.2rem">ðŸ€„</div>`;

      const back = document.createElement("div");
      back.className = "face back" + (card.type === "meaning" ? " french" : "");
      back.innerHTML = card.type === "hanzi"
        ? `<div class="hanzi">${escapeHtml(card.hanzi)}</div><div class="pinyin">${escapeHtml(card.pinyin)}</div>`
        : `<div class="meaning">${escapeHtml(card.meaning)}</div>`;

      inner.append(front, back);
      el.append(inner);
      el.addEventListener("click", ()=> onFlip(el));
      return el;
    }

    function renderBoard(){
      boardEl.innerHTML = "";
      deck.forEach(c => boardEl.appendChild(cardEl(c)));
    }

    // ---- game logic ----
    function resetStats(){
      game.moves = 0;
      game.matches = 0;
      game.flipped = [];
      movesEl.textContent = "0";
      matchesEl.textContent = "0";
      timerEl.textContent = "00:00";
      if (timerId) clearInterval(timerId);
      game.startedAt = 0;
    }

    function startTimer(){
      game.startedAt = Date.now();
      timerId = setInterval(()=>{
        const sec = Math.floor((Date.now() - game.startedAt)/1000);
        timerEl.textContent = fmtTime(sec);
      }, 1000);
    }

    function onFlip(card){
      if (card.classList.contains("flipped") || card.classList.contains("matched")) return;
      if (game.flipped.length >= 2) return;

      // é–‹å§‹è¨ˆæ™‚
      if (!game.startedAt) startTimer();

      card.classList.add("flipped");
      game.flipped.push(card);

      if (game.flipped.length === 2){
        game.moves++;
        movesEl.textContent = game.moves.toString();

        const [a,b] = game.flipped;
        const same = a.dataset.pair === b.dataset.pair;

        if (same){
          setTimeout(()=> {
            a.classList.add("matched");
            b.classList.add("matched");
            game.flipped = [];
            game.matches++;
            matchesEl.textContent = game.matches.toString();
            if (game.matches * 2 >= deck.length) endGame(true);
          }, 220); // å°å»¶é²ä»¥é¡¯ç¤ºç¿»é¢æ•ˆæžœ
        }else{
          // æ”¾æ…¢ 2 ç§’å†è“‹å›ž
          setTimeout(()=>{
            a.classList.remove("flipped");
            b.classList.remove("flipped");
            game.flipped = [];
          }, FLIP_BACK_DELAY);
        }
      }
    }

    function endGame(victory){
      if (timerId) clearInterval(timerId);
      if (victory){
        setTimeout(()=> victoryEl.style.display = "grid", 300);
      }
    }

    // ---- main flows ----
    async function init(){
      // Difficulty/filters åˆå§‹å€¼ï¼ˆå¯å¾ž URL é‚„åŽŸï¼‰
      selDifficulty.value = params.get("mode") || "easy";

      try{
        await fetchItems();
        buildFilters();
        applyAndStart();
      }catch(e){
        console.error(e);
        loadingEl.textContent = "Failed to load data.";
      }

      // bind UI
      document.getElementById("newGameBtn").addEventListener("click", ()=>{ applyAndStart(); });
      document.getElementById("playAgainBtn").addEventListener("click", ()=>{
        victoryEl.style.display = "none";
        applyAndStart();
      });

      [selDifficulty, selBook, selLesson, selLevel, selPos].forEach(sel=>{
        sel.addEventListener("change", ()=>{
          updateURL();
          applyAndStart();
        });
      });
    }

    function applyAndStart(){
      levelTag.textContent = selDifficulty.value === "advanced" ? "Advanced" : "Easy";

      filterPool();
      buildDeck();
      renderBoard();
      resetStats();
    }

    // ---- utils ----
    function escapeHtml(s=""){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
      }[m]));
    }

    // GO!
    init();
  </script>
</body>
</html>
